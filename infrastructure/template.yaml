AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  AI Techne Academy - Video Processing Pipeline Infrastructure
  Phase 1.2: Base Infrastructure (S3, DynamoDB, SNS, IAM, CloudWatch)

Metadata:
  AWS::ServerlessRepo::Application:
    Name: ai-techne-academy
    Description: Automated training document generation from video transcriptions
    Author: AI Techne Academy Team
    SpdxLicenseId: MIT
    Labels: ['video-processing', 'llm', 'bedrock', 'transcription']

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment name (dev, staging, or prod)

  ProjectName:
    Type: String
    Default: ai-techne-academy
    Description: Project name used for resource naming

  NotificationEmail:
    Type: String
    Default: devops@techne.com.br
    Description: Email address for SNS notifications
    AllowedPattern: ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$

  InputBucketRetentionDays:
    Type: Number
    Default: 30
    Description: Days before moving input videos to Glacier

  TranscriptionBucketRetentionDays:
    Type: Number
    Default: 7
    Description: Days before deleting transcription files

  LogRetentionDays:
    Type: Number
    Default: 30
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]
    Description: CloudWatch Logs retention in days

Globals:
  Function:
    Runtime: python3.12
    Timeout: 900
    MemorySize: 1024
    Environment:
      Variables:
        LOG_LEVEL: INFO
        ENVIRONMENT: !Ref Environment
        PROJECT_NAME: !Ref ProjectName

Resources:
  # ========================================
  # S3 Buckets
  # ========================================
  
  InputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-input-${Environment}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: ArchiveOldVideos
            Status: Enabled
            Transitions:
              - TransitionInDays: !Ref InputBucketRetentionDays
                StorageClass: GLACIER
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  OutputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-output-${Environment}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  TranscriptionBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-transcripts-${Environment}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldTranscriptions
            Status: Enabled
            ExpirationInDays: !Ref TranscriptionBucketRetentionDays
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM
        - Key: Purpose
          Value: Temporary transcription storage

  # ========================================
  # DynamoDB Table for Tracking
  # ========================================
  
  ProcessingTrackingTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-tracking-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: execution_id
          AttributeType: S
        - AttributeName: video_key
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
      KeySchema:
        - AttributeName: execution_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: video-key-index
          KeySchema:
            - AttributeName: video_key
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  # ========================================
  # SNS Topic for Notifications
  # ========================================
  
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-notifications-${Environment}'
      DisplayName: !Sub 'AI Techne Academy ${Environment} Notifications'
      KmsMasterKeyId: alias/aws/sns
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  NotificationTopicSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref NotificationTopic
      Endpoint: !Ref NotificationEmail

  NotificationTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref NotificationTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowEventBridgeToPublish
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sns:Publish
            Resource: !Ref NotificationTopic
          - Sid: AllowLambdaToPublish
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sns:Publish
            Resource: !Ref NotificationTopic
            Condition:
              StringEquals:
                'aws:SourceAccount': !Ref 'AWS::AccountId'

  # ========================================
  # CloudWatch Log Groups
  # ========================================
  
  StateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/vendedlogs/states/${ProjectName}-${Environment}'
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  ProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/ecs/${ProjectName}-processor-${Environment}'
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}'
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  # ========================================
  # IAM Roles (Prepared for Future Use)
  # ========================================
  
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-lambda-execution-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt InputBucket.Arn
                  - !Sub '${InputBucket.Arn}/*'
                  - !GetAtt OutputBucket.Arn
                  - !Sub '${OutputBucket.Arn}/*'
                  - !GetAtt TranscriptionBucket.Arn
                  - !Sub '${TranscriptionBucket.Arn}/*'
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt ProcessingTrackingTable.Arn
                  - !Sub '${ProcessingTrackingTable.Arn}/index/*'
        - PolicyName: SNSPublish
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref NotificationTopic
        - PolicyName: TranscribeAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - transcribe:StartTranscriptionJob
                  - transcribe:GetTranscriptionJob
                  - transcribe:ListTranscriptionJobs
                Resource: '*'
        - PolicyName: CloudWatchMetrics
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-ecs-execution-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-ecs-task-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub '${InputBucket.Arn}/*'
                  - !Sub '${TranscriptionBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource:
                  - !Sub '${OutputBucket.Arn}/*'
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource: !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/*'
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:GetItem
                Resource: !GetAtt ProcessingTrackingTable.Arn
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub '${ProcessorLogGroup.Arn}:*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  # ========================================
  # ECR Repository for Processor Container
  # ========================================
  
  ProcessorRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub '${ProjectName}/processor'
      ImageScanningConfiguration:
        ScanOnPush: true
      ImageTagMutability: MUTABLE
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Expire untagged images older than 7 days",
                "selection": {
                  "tagStatus": "untagged",
                  "countType": "sinceImagePushed",
                  "countUnit": "days",
                  "countNumber": 7
                },
                "action": {
                  "type": "expire"
                }
              },
              {
                "rulePriority": 2,
                "description": "Keep last 5 images",
                "selection": {
                  "tagStatus": "any",
                  "countType": "imageCountMoreThan",
                  "countNumber": 5
                },
                "action": {
                  "type": "expire"
                }
              }
            ]
          }
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM
        - Key: Component
          Value: Processor

  # ========================================
  # Lambda Functions
  # ========================================
  
  TriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-trigger-${Environment}'
      Description: Trigger function that responds to S3 video uploads
      CodeUri: ../src/functions/trigger/
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 60
      MemorySize: 256
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          TRACKING_TABLE: !Ref ProcessingTrackingTable
          ENVIRONMENT: !Ref Environment
          LOG_LEVEL: INFO
      Events:
        S3Event:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - aws.s3
              detail-type:
                - Object Created
              detail:
                bucket:
                  name:
                    - !Ref InputBucket
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment
        ManagedBy: SAM
        Function: Trigger
  TranscribeStarterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-transcribe-starter-${Environment}'
      Description: Starts AWS Transcribe jobs with speaker identification
      CodeUri: ../src/functions/transcribe/
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 60
      MemorySize: 256
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          TRACKING_TABLE: !Ref ProcessingTrackingTable
          OUTPUT_BUCKET: !Ref TranscriptionBucket
          LANGUAGE_CODE: pt-BR
          MAX_SPEAKERS: 10
          ENVIRONMENT: !Ref Environment
          LOG_LEVEL: INFO
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment
        ManagedBy: SAM
        Function: TranscribeStarter
  FinalizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-finalizer-${Environment}'
      Description: Finalizes execution by updating status, sending notifications, and recording metrics
      CodeUri: ../src/functions/finalizer/
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 90
      MemorySize: 256
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          TRACKING_TABLE: !Ref ProcessingTrackingTable
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
          OUTPUT_BUCKET: !Ref OutputBucket
          ENVIRONMENT: !Ref Environment
          LOG_LEVEL: INFO
          MAX_RETRY_ATTEMPTS: 3
          RETRY_DELAY_BASE: 1
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment
        ManagedBy: SAM
        Function: Finalizer

  # ========================================
  # ECS Cluster and Task Definition
  # ========================================
  
  ProcessingCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub '${ProjectName}-${Environment}'
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  ProcessingTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub '${ProjectName}-processor-${Environment}'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: '2048'
      Memory: '8192'
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: processor
          Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ProjectName}/processor:latest'
          Essential: true
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref ProcessorLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: processor
          Environment:
            - Name: OUTPUT_BUCKET
              Value: !Ref OutputBucket
            - Name: TRANSCRIPTION_BUCKET
              Value: !Ref TranscriptionBucket
            - Name: TRACKING_TABLE
              Value: !Ref ProcessingTrackingTable
            - Name: BEDROCK_MODEL_ID
              Value: anthropic.claude-sonnet-4-5-20250929-v1:0
            - Name: AWS_REGION
              Value: !Ref AWS::Region
            - Name: ENVIRONMENT
              Value: !Ref Environment
            - Name: LOG_LEVEL
              Value: INFO
            - Name: MAX_TOKENS_PER_CHUNK
              Value: '100000'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  # ========================================
  # Step Functions State Machine
  # ========================================
  
  StateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-statemachine-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: StateMachineExecutionPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt TranscribeStarterFunction.Arn
                  - !GetAtt FinalizerFunction.Arn
              - Effect: Allow
                Action:
                  - transcribe:GetTranscriptionJob
                Resource: '*'
              - Effect: Allow
                Action:
                  - ecs:RunTask
                  - ecs:StopTask
                  - ecs:DescribeTasks
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  - !GetAtt ECSTaskExecutionRole.Arn
                  - !GetAtt ECSTaskRole.Arn
              - Effect: Allow
                Action:
                  - events:PutTargets
                  - events:PutRule
                  - events:DescribeRule
                Resource: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/StepFunctions*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  ProcessingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub '${ProjectName}-workflow-${Environment}'
      DefinitionUri: statemachine/workflow.asl.json
      DefinitionSubstitutions:
        TranscribeStarterFunctionArn: !GetAtt TranscribeStarterFunction.Arn
        FinalizerFunctionArn: !GetAtt FinalizerFunction.Arn
        ECSClusterArn: !GetAtt ProcessingCluster.Arn
        ECSTaskDefinitionArn: !Ref ProcessingTaskDefinition
        SubnetId: !Ref AWS::NoValue
      Role: !GetAtt StateMachineRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StateMachineLogGroup.Arn
      Tracing:
        Enabled: true
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment
        ManagedBy: SAM

  # ========================================
  # EventBridge Rule to Trigger State Machine
  # ========================================
  
  EventBridgeRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-eventbridge-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: StartStateMachine
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: states:StartExecution
                Resource: !GetAtt ProcessingStateMachine.Arn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: SAM

  VideoUploadRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-video-upload-${Environment}'
      Description: Trigger video processing workflow when video is uploaded to S3
      State: ENABLED
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - Object Created
        detail:
          bucket:
            name:
              - !Ref InputBucket
          object:
            key:
              - prefix: ''
      Targets:
        - Arn: !GetAtt ProcessingStateMachine.Arn
          RoleArn: !GetAtt EventBridgeRole.Arn
          Id: VideoProcessingStateMachine

# ========================================
# Outputs
# ========================================

Outputs:
  # S3 Buckets
  InputBucketName:
    Description: Name of the input S3 bucket for video uploads
    Value: !Ref InputBucket
    Export:
      Name: !Sub '${AWS::StackName}-InputBucket'

  InputBucketArn:
    Description: ARN of the input S3 bucket
    Value: !GetAtt InputBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-InputBucketArn'

  OutputBucketName:
    Description: Name of the output S3 bucket for generated documents
    Value: !Ref OutputBucket
    Export:
      Name: !Sub '${AWS::StackName}-OutputBucket'

  OutputBucketArn:
    Description: ARN of the output S3 bucket
    Value: !GetAtt OutputBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-OutputBucketArn'

  TranscriptionBucketName:
    Description: Name of the transcription S3 bucket
    Value: !Ref TranscriptionBucket
    Export:
      Name: !Sub '${AWS::StackName}-TranscriptionBucket'

  TranscriptionBucketArn:
    Description: ARN of the transcription S3 bucket
    Value: !GetAtt TranscriptionBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TranscriptionBucketArn'

  # DynamoDB
  TrackingTableName:
    Description: Name of the DynamoDB tracking table
    Value: !Ref ProcessingTrackingTable
    Export:
      Name: !Sub '${AWS::StackName}-TrackingTable'

  TrackingTableArn:
    Description: ARN of the DynamoDB tracking table
    Value: !GetAtt ProcessingTrackingTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TrackingTableArn'

  TrackingTableStreamArn:
    Description: Stream ARN of the DynamoDB tracking table
    Value: !GetAtt ProcessingTrackingTable.StreamArn
    Export:
      Name: !Sub '${AWS::StackName}-TrackingTableStream'

  TranscribeStarterFunctionArn:
    Description: ARN of the Transcribe Starter Lambda function
    Value: !GetAtt TranscribeStarterFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TranscribeStarterFunction'

  TranscribeStarterFunctionName:
    Description: Name of the Transcribe Starter Lambda function
    Value: !Ref TranscribeStarterFunction

  FinalizerFunctionArn:
    Description: ARN of the Finalizer Lambda function
    Value: !GetAtt FinalizerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-FinalizerFunction'

  FinalizerFunctionName:
    Description: Name of the Finalizer Lambda function
    Value: !Ref FinalizerFunction

  # SNS
  NotificationTopicArn:
    Description: ARN of the SNS notification topic
    Value: !Ref NotificationTopic
    Export:
      Name: !Sub '${AWS::StackName}-NotificationTopic'

  NotificationTopicName:
    Description: Name of the SNS notification topic
    Value: !GetAtt NotificationTopic.TopicName

  # CloudWatch Log Groups
  StateMachineLogGroupName:
    Description: Name of the Step Functions log group
    Value: !Ref StateMachineLogGroup
  # Lambda Functions
  TriggerFunctionArn:
    Description: ARN of the Trigger Lambda function
    Value: !GetAtt TriggerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TriggerFunction'

  TriggerFunctionName:
    Description: Name of the Trigger Lambda function
    Value: !Ref TriggerFunction


  ProcessorLogGroupName:
    Description: Name of the ECS processor log group
    Value: !Ref ProcessorLogGroup

  LambdaLogGroupName:
    Description: Name of the Lambda functions log group
    Value: !Ref LambdaLogGroup

  # IAM Roles
  LambdaExecutionRoleArn:
    Description: ARN of the Lambda execution role
    Value: !GetAtt LambdaExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaExecutionRole'

  ECSTaskExecutionRoleArn:
    Description: ARN of the ECS task execution role
    Value: !GetAtt ECSTaskExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ECSTaskExecutionRole'

  ECSTaskRoleArn:
    Description: ARN of the ECS task role
    Value: !GetAtt ECSTaskRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ECSTaskRole'

  # ECR Repository
  ProcessorRepositoryUri:
    Description: URI of the ECR repository for processor container
    Value: !GetAtt ProcessorRepository.RepositoryUri
    Export:
      Name: !Sub '${AWS::StackName}-ProcessorRepositoryUri'

  ProcessorRepositoryArn:
    Description: ARN of the ECR repository
    Value: !GetAtt ProcessorRepository.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ProcessorRepositoryArn'

  ProcessorRepositoryName:
    Description: Name of the ECR repository
    Value: !Ref ProcessorRepository

  # Stack Info
  StackName:
    Description: Name of this CloudFormation stack
    Value: !Ref 'AWS::StackName'

  Region:
    Description: AWS Region where resources are deployed
    Value: !Ref 'AWS::Region'

  Environment:
    Description: Environment name (dev, staging, prod)
    Value: !Ref Environment

  # ECS Cluster
  ECSClusterArn:
    Description: ARN of the ECS cluster for processor tasks
    Value: !GetAtt ProcessingCluster.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ECSCluster'

  ECSClusterName:
    Description: Name of the ECS cluster
    Value: !Ref ProcessingCluster

  # ECS Task Definition
  ECSTaskDefinitionArn:
    Description: ARN of the ECS task definition
    Value: !Ref ProcessingTaskDefinition
    Export:
      Name: !Sub '${AWS::StackName}-ECSTaskDefinition'

  # Step Functions State Machine
  StateMachineArn:
    Description: ARN of the Step Functions state machine
    Value: !GetAtt ProcessingStateMachine.Arn
    Export:
      Name: !Sub '${AWS::StackName}-StateMachine'

  StateMachineName:
    Description: Name of the Step Functions state machine
    Value: !GetAtt ProcessingStateMachine.Name

  StateMachineRoleArn:
    Description: ARN of the Step Functions execution role
    Value: !GetAtt StateMachineRole.Arn

  # EventBridge Rule
  VideoUploadRuleArn:
    Description: ARN of the EventBridge rule for video uploads
    Value: !GetAtt VideoUploadRule.Arn

  VideoUploadRuleName:
    Description: Name of the EventBridge rule
    Value: !Ref VideoUploadRule